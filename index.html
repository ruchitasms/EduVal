<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Energy Valuation & Performance</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .result-card { display: none; margin-top: 20px; }
        .chart-container { height:250px; margin-bottom: 20px; }
        .pos { color: #27ae60; }
        .neg { color: #e74c3c; }
        progress { display: none; }
    </style>
</head>
<body>
    <main class="container">
        <hgroup style="margin-top:40px;">
            <h1>Energy Valuation Tracker</h1>
            <p>Relative Valuation & Market Performance</p>
        </hgroup>

        <article>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="ticker" placeholder="XOM" style="margin-bottom:0;">
                <button onclick="getValuation()">Analyze</button>
            </div>
            <progress id="loader"></progress>
        </article>

        <div id="output" class="result-card">
            <div class="grid">
                <article>
                    <header><h4 id="compName">Company</h4></header>
                    <p><strong>EV/EBITDA:</strong> <span id="multiple"></span></p>
                    <p><strong>Status:</strong> <span id="status"></span></p>
                    <div class="chart-container">
                        <canvas id="valChart"></canvas>
                    </div>
                </article>

                <article>
                    <header><h4>Market Performance</h4></header>
                    <table role="grid">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody id="perfBody">
                            </tbody>
                    </table>
                </article>
            </div>
        </div>
    </main>

    <script>
        let myChart = null;

        async function getValuation() {
            const ticker = document.getElementById('ticker').value.toUpperCase();
            if(!ticker) return;

            document.getElementById('loader').style.display = 'block';
            document.getElementById('output').style.display = 'none';

            try {
                // Using a robust, CORS-friendly financial API
                const res = await fetch(`https://api.api-ninjas.com/v1/stockprice?ticker=${ticker}`, {
                    headers: { 'X-Api-Key': 'YOUR_FREE_API_NINJA_KEY_HERE' } 
                });
                
                // ALTERNATIVE: Using the brapi mirror if you don't have a key yet
                const response = await fetch(`https://brapi.dev/api/quote/${ticker}`);
                const data = await response.json();
                const stock = data.results[0];

                // Calculation Logic
                const mkt = stock.marketCap || 0;
                const debt = stock.totalDebt || 0;
                const cash = stock.totalCash || 0;
                const ev = mkt + debt - cash;
                const multiple = ev / (stock.ebitda || 1);

                // UI Updates
                document.getElementById('compName').innerText = stock.longName || ticker;
                document.getElementById('multiple').innerText = `${multiple.toFixed(2)}x`;
                document.getElementById('status').innerText = multiple < 8 ? "Undervalued" : "Growth/Premium";

                // Performance Logic
                const change = stock.regularMarketChangePercent || 0;
                document.getElementById('perfBody').innerHTML = `
                    <tr><td>Daily Change</td><td class="${change >= 0 ? 'pos' : 'neg'}">${change.toFixed(2)}%</td></tr>
                    <tr><td>52W High</td><td>$${stock.fiftyTwoWeekHigh}</td></tr>
                    <tr><td>52W Low</td><td>$${stock.fiftyTwoWeekLow}</td></tr>
                    <tr><td>Market Cap</td><td>$${(mkt/1e9).toFixed(2)}B</td></tr>
                `;

                renderChart(mkt, debt, cash);
                document.getElementById('output').style.display = 'block';
            } catch (e) {
                alert("API limit reached or Ticker not found. Please try again in a moment.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderChart(mkt, debt, cash) {
            const ctx = document.getElementById('valChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut', // Doughnut is great for showing "composition"
                data: {
                    labels: ['Market Cap', 'Debt', 'Cash'],
                    datasets: [{
                        data: [mkt, debt, cash],
                        backgroundColor: ['#3b4d61', '#d35400', '#27ae60']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
