<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>EduVal - Financial Literacy Pro (Phase 3)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --pico-primary: #00a8e8; --pico-background-color: #0b0e14; --pico-card-background-color: #151921; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 1rem; }
        .nav-tabs button { flex: 1; font-size: 0.8rem; padding: 10px; }
        .dashboard-grid { display: grid; grid-template-columns: 1.2fr 1.3fr; gap: 1.5rem; }
        .sts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .sts-card { background: var(--pico-card-background-color); padding: 1rem; border-radius: 8px; border-top: 3px solid var(--pico-primary); }
        .traffic-light { padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; display: inline-block; margin: 8px 0; color: #fff; }
        .metric-row { display: flex; justify-content: space-between; border-bottom: 1px solid #2a313d; padding: 5px 0; font-size: 0.85rem; }
        .chart-wrapper { height: 300px; width: 100%; position: relative; }
        .verdict-badge { padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; color: #fff; white-space: nowrap; }
        .section-sub { font-size: 0.75rem; color: #888; margin-bottom: 10px; display: block; }
        .fy-anchor { font-weight: bold; color: var(--pico-primary); font-size: 0.85rem; background: #1c222d; padding: 2px 8px; border-radius: 4px; }
        progress { display: none; margin: 10px 0; }

        /* --- Risk Section Styles (Phase 3) --- */
        .risk-container { display: grid; grid-template-columns: 1fr 1.2fr; gap: 2rem; }
        .risk-kpi-row { display: flex; gap: 10px; margin-bottom: 1rem; }
        .risk-kpi-badge { flex: 1; padding: 8px; text-align: center; border-radius: 6px; font-weight: bold; font-size: 0.85rem; border: 1px solid #333; }
        .risk-header { color: var(--pico-primary); font-weight: bold; margin-bottom: 1rem; border-bottom: 1px solid var(--pico-primary); padding-bottom: 5px; display: block; }
        .donut-wrapper { height: 220px; position: relative; display: flex; justify-content: center; margin-bottom: 1rem; }
        .risk-text-box { background: #1c222d; padding: 1rem; border-radius: 6px; border-left: 4px solid var(--pico-primary); font-size: 0.85rem; }
    </style>
</head>
<body>
    <main class="container">
        <h2>EduVal - Let's learn Finance Together! ðŸ¦‰</h2>
        
        <header>
            <select id="tickerSelect" onchange="runAnalysis(this.value)">
                <option value="" disabled selected>Select Company to Start Analysis...</option>
                <option value="XOM">ExxonMobil (Energy)</option>
                <option value="CVX">Chevron (Energy)</option>
                <option value="NVDA">NVIDIA (Semiconductors)</option>
                <option value="MSFT">Microsoft (Software)</option>
                <option value="GOOGL">Alphabet (Tech)</option>
                <option value="NFLX">Netflix (Entertainment)</option>
                <option value="TSLA">Tesla (Automotive)</option>
                <option value="DIS">Disney (Entertainment)</option>
                <option value="INTC">Intel (Semiconductors)</option>
                <option value="SOFI">SoFi (Fintech)</option>
            </select>
            <progress id="loader"></progress>
        </header>

        <div id="mainUI" style="display:none;">
            <div class="nav-tabs">
                <button id="btn-val" onclick="switchTab('val')">Valuation</button>
                <button id="btn-sts" onclick="switchTab('sts')">Statements</button>
                <button id="btn-rsk" onclick="switchTab('rsk')">Risk Diagnostics</button> </div>

            <details id="lessonBox" style="background: #1c222d; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <summary>Formulas & Rules of Thumb</summary>
                <div id="lessonContent" style="font-size: 0.85rem; margin-top: 10px; line-height: 1.6;"></div>
            </details>

            <div id="view-val" class="dashboard-grid">
                <article>
                    <header style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 id="compName" style="margin:0;">-</h4>
                            <small id="industryLabel">-</small>
                        </div>
                        <span id="verdictBadge" class="verdict-badge">-</span>
                    </header>
                    <label>EV / EBITDA Multiple</label>
                    <h1 id="evEbitdaDisplay" style="color: var(--pico-primary); margin:0;">-</h1>
                    <table role="grid">
                        <tr class="metric-row"><td>Net Debt / EBITDA</td><td id="leverageVal" align="right">-</td></tr>
                        <tr class="metric-row"><td>52-Week Range</td><td id="rangeVal" align="right">-</td></tr>
                        <tr class="metric-row"><td>Enterprise Value</td><td id="evVal" align="right">-</td></tr>
                    </table>
                    <footer><span class="fy-anchor" id="val-fy">Audited: -</span></footer>
                </article>
                <article>
                    <header>
                        <div style="display: flex; justify-content: space-between; align-items: baseline;">
                            <strong>7-Day Momentum (2026)</strong>
                            <div>
                                <span id="priceDisplay" style="color:var(--pico-primary); font-weight:bold; margin-right:15px;">Price: -</span><br>
                                <small id="mktCapVal" style="color:#888;">Cap: -</small>
                            </div>
                        </div>
                    </header>  
                    <div class="chart-wrapper"><canvas id="priceChart"></canvas></div>
                </article>
            </div>

            <div id="view-sts" style="display:none;">
                <div style="margin-bottom: 10px;"><span class="fy-anchor" id="sts-fy">Fiscal Year: -</span></div>
                <div class="sts-grid">
                    <div class="sts-card">
                        <h6 style="margin:0;">Balance Sheet</h6>
                        <span class="section-sub">Company's Net Worth</span>
                        <div class="metric-row"><span>Current Ratio</span><span id="currRatioVal">-</span></div>
                        <div id="crLight" class="traffic-light">-</div>
                        <hr>
                        <div class="metric-row"><span>Quick Ratio</span><span id="quickRatioVal">-</span></div>
                        <div class="metric-row"><span>Total Assets</span><span id="assetsVal">-</span></div>
                        <div class="metric-row"><span>Total Liab.</span><span id="liabVal">-</span></div>
                        <div class="metric-row" style="border-top: 1px dashed #444; margin-top:5px;">
                            <span>Enterprise Value</span><span id="evValSts" style="color:var(--pico-primary)">-</span>
                        </div>
                    </div>

                    <div class="sts-card">
                        <h6 style="margin:0;">Income Statement</h6>
                        <span class="section-sub">Company's Profitability</span>
                        <div class="metric-row"><span>Net Margin</span><span id="netMarginVal">-</span></div>
                        <div id="incLight" class="traffic-light">-</div>
                        <hr>
                        <div class="metric-row"><span>EPS Growth</span><span id="epsGrowthVal">-</span></div>
                        <div class="metric-row"><span>Revenue</span><span id="revVal">-</span></div>
                        <div class="metric-row"><span>Net Income</span><span id="netIncVal">-</span></div>
                        <div class="metric-row" style="border-top: 1px dashed #444; margin-top:5px;">
                            <span>EBITDA</span><span id="ebitdaValSts" style="color:var(--pico-primary)">-</span>
                        </div>
                    </div>

                    <div class="sts-card">
                        <h6 style="margin:0;">Cash Flow</h6>
                        <span class="section-sub">Company's Cash Generation</span>
                        <div class="metric-row"><span>Cash Conversion</span><span id="cashConvVal">-</span></div>
                        <div id="cfLight" class="traffic-light">-</div>
                        <hr>
                        <div class="metric-row"><span>Working Cap</span><span id="workCapVal">-</span></div>
                        <div class="metric-row"><span>Operating CF</span><span id="ocfVal">-</span></div>
                        <div class="metric-row"><span>Free Cash Flow</span><span id="fcfVal" style="color:var(--pico-primary)">-</span></div>
                    </div>
                </div>
            </div>

            <div id="view-rsk" style="display:none;">
                <div class="risk-container">
                    <div>
                        <span class="risk-header">Structural Health</span>
                        <div class="metric-row"><span>Operating Cycle (Days)</span><span id="rsk-opCycle">-</span></div>
                        <div class="metric-row"><span>Debt to Equity Ratio</span><span id="rsk-deRatio">-</span></div>
                        <div class="metric-row"><span>Interest Coverage</span><span id="rsk-intCov">-</span></div>
                        <div class="metric-row"><span>Financial Leverage</span><span id="rsk-finLev">-</span></div>
                        <div class="metric-row"><span>Cash Ratio</span><span id="rsk-cashRatio">-</span></div>
                        <div class="metric-row"><span>Solvency Ratio</span><span id="rsk-solvency">-</span></div>

                        <br>
                        <span class="risk-header">Market Context</span>
                        <div class="metric-row"><span>Dividend Yield %</span><span id="rsk-divYield">-</span></div>
                        <div class="metric-row"><span>Price to Earnings (P/E)</span><span id="rsk-pe">-</span></div>
                    </div>

                    <div>
                        <div class="risk-kpi-row">
                            <div id="badge-cr" class="risk-kpi-badge">CR: -</div>
                            <div id="badge-mr" class="risk-kpi-badge">Margin: -</div>
                            <div id="badge-cv" class="risk-kpi-badge">Conv: -</div>
                        </div>

                        <div style="text-align:center; margin-bottom:5px;">Liquidity Composition</div>
                        <div class="donut-wrapper">
                            <canvas id="liquidityChart"></canvas>
                        </div>

                        <div class="risk-text-box">
                            <h6 style="margin:0; color:var(--pico-primary);">Business Model & Risk Profile</h6>
                            <p id="risk-narrative" style="margin-top:5px; margin-bottom:0; color:#ccc;">-</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        let priceChart = null;
        let liquidityChart = null; // New chart instance
        const API_KEY = '1YJOf8Lz9qJUlyPUhgKqc3vpzMflW1mx'; // Demo key
        const sectorThemes = { 'Energy': '#00e676', 'Semiconductors': '#ff9100', 'Software': '#00d4ff', 'Tech': '#a29bfe', 'Entertainment': '#ff4081', 'Automotive': '#ffffff', 'Fintech': '#ffcc00' };

        const learnings = {
            val: `<strong>Valuation Tag Logic:</strong><br>
                  <strong>Introduction</strong><br>
                  â€¢ Enterprise Value: It represents the total price tag of a company, calculated as Market Cap + Total Debt - Cash. Here, Market Cap = (Current Share Price x Current Outstanding Shares)<br>
                  â€¢ Relative Valuation: This involves comparing a company's value to its peers using multiples like EV/EBITDA(used across industries because it neutralizes the effects of different debt levels and tax environments)<br>
                  <br><strong>Reading Values:</strong><br>
                  â€¢ <strong>Value Play (< 10x):</strong> "Cheap" relative to cash profits. (Ex: Energy/Banking)<br>
                  â€¢ <strong>Fair Value (10x-25x):</strong> Balanced market expectation. (Ex: Microsoft/Alphabet)<br>
                  â€¢ <strong>Premium Growth (> 25x):</strong> Market expects future earnings explosion. (Ex: NVIDIA/Tesla)<br><br>
                  <strong>Formulas:</strong><br>
                  â€¢ EV/EBITDA: Enterprise Value / EBITDA<br>
                  â€¢ Net Debt/EBITDA: (Total Debt - Cash) / EBITDA`,
            sts: `â€¢ These are the "report cards" of a company, consisting of the Balance Sheet (what you own/owe), Income Statement (profitability), and Cash Flow Statement (actual cash moving in and out).<br>
                  <br><strong>Financial Statement Tags:</strong><br>
                  â€¢ <strong>Liquidity (Current Ratio):</strong>This measures a companyâ€™s "cash cushion" or its ability to pay off its immediate, short-term debts using assets that can be quickly converted into cash. Goal > 1.2 (Current Assets / Current Liab).<br>
                  â€¢ <strong>Efficiency (Net Margin):</strong>This tracks how well a company manages its resources to generate profit, often measured by "Net Margin" to see how much profit is kept from every dollar of revenue.. Goal > 15% (Net Income / Revenue).<br>
                  â€¢ <strong>Quality (Cash Conv):</strong>This determines if reported profits are "real" by checking if the company is actually generating hard cash (Cash Conversion) rather than just accounting entries. Goal â‰¥ 1.0 (Free Cash Flow / Net Income).<br><br>
                  <strong>Formulas:</strong><br>
                  â€¢ Current Ratio: Current Assets / Current Liab<br>
                  â€¢ Quick Ratio: (Cash + Receivables) / Current Liab<br>
                  â€¢ Working Capital: Current Assets - Current Liabilities
                  â€¢ Cash Conversion: Free Cash Flow / Net Income
                  â€¢ PS: The EV displayed here is as of the share price while the statements data was made available, hence the calculation here and on the valuation page may differ.`,
            rsk: `<strong>Risk Diagnostics Guide:</strong><br>
                  â€¢ <strong>Structural Health:</strong> Can the company survive a storm? We look at debt levels and how long it takes to turn inventory into cash (Operating Cycle).<br>
                  â€¢ <strong>Liquidity Composition:</strong> Not all "current assets" are equal. Cash is king. High inventory or receivables can be risky if customers don't pay or products don't sell.<br>
                  â€¢ <strong>Business Model Profile:</strong> We analyze the interaction between Liquidity, Margins, and Cash Conversion to diagnose the specific operational risks the business faces.`
        };

        function switchTab(tabId) {
            document.getElementById('view-val').style.display = tabId === 'val' ? 'grid' : 'none';
            document.getElementById('view-sts').style.display = tabId === 'sts' ? 'block' : 'none';
            document.getElementById('view-rsk').style.display = tabId === 'rsk' ? 'block' : 'none';
            document.getElementById('lessonContent').innerHTML = learnings[tabId];
        }

        async function runAnalysis(ticker) {
            document.getElementById('loader').style.display = 'block';
            try {
                const [pRes, mRes, hRes, incRes, bsRes, cfRes] = await Promise.all([
                    fetch(`https://financialmodelingprep.com/stable/profile?symbol=${ticker}&apikey=${API_KEY}`),
                    fetch(`https://financialmodelingprep.com/stable/key-metrics?symbol=${ticker}&apikey=${API_KEY}`),
                    fetch(`https://financialmodelingprep.com/stable/historical-price-eod/light?symbol=${ticker}&apikey=${API_KEY}`),
                    fetch(`https://financialmodelingprep.com/stable/income-statement?symbol=${ticker}&limit=2&apikey=${API_KEY}`),
                    fetch(`https://financialmodelingprep.com/stable/balance-sheet-statement?symbol=${ticker}&limit=1&apikey=${API_KEY}`),
                    fetch(`https://financialmodelingprep.com/stable/cash-flow-statement?symbol=${ticker}&limit=1&apikey=${API_KEY}`)
                ]);

                const profile = (await pRes.json())[0];
                const metrics = (await mRes.json())[0];
                const history = (await hRes.json()).slice(0, 7).reverse();
                const inc = await incRes.json();
                const bs = (await bsRes.json())[0];
                const cf = (await cfRes.json())[0];

                const industry = document.getElementById('tickerSelect').selectedOptions[0].text.match(/\(([^)]+)\)/)[1];
                const themeColor = sectorThemes[industry] || '#00a8e8';
                document.documentElement.style.setProperty('--pico-primary', themeColor);

                // Header & Year
                document.getElementById('compName').innerText = profile.companyName;
                document.getElementById('industryLabel').innerText = `${industry} | ${ticker}`;
                document.getElementById('priceDisplay').innerText = `Price: $${profile.price.toFixed(2)}`;
                document.getElementById('mktCapVal').innerText = `Cap: $${(profile.marketCap / 1e9).toFixed(1)}B`;
                const yearText = bs.calendarYear || "2025";
                document.getElementById('val-fy').innerText = `Audited: FY ${yearText}`;
                document.getElementById('sts-fy').innerText = `Fiscal Year: ${yearText}`;

                // Valuation
                const evEbitda = metrics.evToEBITDA;
                document.getElementById('evEbitdaDisplay').innerText = evEbitda.toFixed(2) + 'x';
                const vBadge = document.getElementById('verdictBadge');
                if(evEbitda < 10) { vBadge.innerText = "Value Play"; vBadge.style.background = "#004d26"; }
                else if(evEbitda < 25) { vBadge.innerText = "Fair Value"; vBadge.style.background = "#664d00"; }
                else { vBadge.innerText = "Premium Growth"; vBadge.style.background = "#3b1e6e"; }

                document.getElementById('leverageVal').innerText = metrics.netDebtToEBITDA.toFixed(2) + 'x';
                document.getElementById('rangeVal').innerText = profile.range;
                document.getElementById('evVal').innerText = `$${(metrics.enterpriseValue / 1e9).toFixed(1)}B`;

                // Statement Logic
                const cr = bs.totalCurrentAssets / bs.totalCurrentLiabilities;
                document.getElementById('currRatioVal').innerText = cr.toFixed(2);
                document.getElementById('crLight').style.background = cr > 1.2 ? "#004d26" : "#4d0000";
                document.getElementById('crLight').innerText = cr > 1.2 ? "Healthy" : "Risk";
                document.getElementById('evValSts').innerText = `$${(metrics.enterpriseValue / 1e9).toFixed(1)}B`;

                const margin = (inc[0].netIncome / inc[0].revenue) * 100;
                document.getElementById('netMarginVal').innerText = margin.toFixed(1) + '%';
                document.getElementById('incLight').style.background = margin > 15 ? "#004d26" : "#664d00";
                document.getElementById('incLight').innerText = margin > 15 ? "High Moat" : "Standard";
                const ebitda = inc[0].ebitda || (inc[0].operatingIncome + (inc[0].depreciationAndAmortization || 0));
                document.getElementById('ebitdaValSts').innerText = `$${(ebitda / 1e9).toFixed(1)}B`;

                const fcf = cf.operatingCashFlow - cf.capitalExpenditure;
                const conv = fcf / inc[0].netIncome;
                document.getElementById('cashConvVal').innerText = conv.toFixed(2) + 'x';
                document.getElementById('cfLight').style.background = conv >= 1.0 ? "#004d26" : "#4d0000";
                document.getElementById('cfLight').innerText = conv >= 1.0 ? "High Quality" : "Accrual Warning";

                // Raw Metrics
                document.getElementById('quickRatioVal').innerText = ((bs.cashAndCashEquivalents + bs.netReceivables) / bs.totalCurrentLiabilities).toFixed(2);
                document.getElementById('assetsVal').innerText = `$${(bs.totalAssets / 1e9).toFixed(1)}B`;
                document.getElementById('liabVal').innerText = `$${(bs.totalLiabilities / 1e9).toFixed(1)}B`;
                document.getElementById('epsGrowthVal').innerText = inc[1] ? (((inc[0].eps - inc[1].eps) / Math.abs(inc[1].eps)) * 100).toFixed(1) + '%' : '0%';
                document.getElementById('revVal').innerText = `$${(inc[0].revenue / 1e9).toFixed(1)}B`;
                document.getElementById('netIncVal').innerText = `$${(inc[0].netIncome / 1e9).toFixed(1)}B`;
                document.getElementById('workCapVal').innerText = `$${((bs.totalCurrentAssets - bs.totalCurrentLiabilities) / 1e9).toFixed(1)}B`;
                document.getElementById('ocfVal').innerText = `$${(cf.operatingCashFlow / 1e9).toFixed(1)}B`;
                document.getElementById('fcfVal').innerText = `$${(fcf / 1e9).toFixed(1)}B`;

                // --- RISK DIAGNOSTICS (PHASE 3) ---
                
                // 1. Structural Health
                document.getElementById('rsk-opCycle').innerText = metrics.operatingCycle ? metrics.operatingCycle.toFixed(1) : "0.0";
                document.getElementById('rsk-deRatio').innerText = metrics.debtToEquity ? metrics.debtToEquity.toFixed(2) : "0.00";
                document.getElementById('rsk-intCov').innerText = metrics.interestCoverage ? metrics.interestCoverage.toFixed(1) + 'x' : "0.0x";
                // Financial Leverage = Assets / Equity
                const finLev = bs.totalAssets / bs.totalStockholdersEquity;
                document.getElementById('rsk-finLev').innerText = isFinite(finLev) ? finLev.toFixed(2) : "0.00";
                // Cash Ratio = Cash / Current Liabilities
                const cashRatio = bs.cashAndCashEquivalents / bs.totalCurrentLiabilities;
                document.getElementById('rsk-cashRatio').innerText = cashRatio.toFixed(2);
                // Solvency Ratio = (Net Income + Deprec) / Total Liabilities
                const solvency = (inc[0].netIncome + inc[0].depreciationAndAmortization) / bs.totalLiabilities;
                document.getElementById('rsk-solvency').innerText = solvency.toFixed(2);

                // 2. Market Context
                document.getElementById('rsk-divYield').innerText = (metrics.dividendYield * 100).toFixed(2) + '%';
                document.getElementById('rsk-pe').innerText = metrics.peRatio ? metrics.peRatio.toFixed(2) + 'x' : "-";

                // 3. Risk Visuals (Top Badges)
                const badgeCR = document.getElementById('badge-cr');
                const badgeMR = document.getElementById('badge-mr');
                const badgeCV = document.getElementById('badge-cv');

                badgeCR.innerText = `CR: ${cr.toFixed(2)}`;
                badgeCR.style.background = cr > 1.2 ? '#004d26' : '#4d0000';
                badgeMR.innerText = `Margin: ${(margin/100).toFixed(2)}`;
                badgeMR.style.background = margin > 15 ? '#004d26' : '#4d0000'; // Using /100 to match user image format (0.07)
                badgeCV.innerText = `Conv: ${conv.toFixed(2)}`;
                badgeCV.style.background = conv >= 1.0 ? '#004d26' : '#4d0000';

                // 4. Donut Chart (Liquidity)
                const ctxLiquidity = document.getElementById('liquidityChart').getContext('2d');
                if (liquidityChart) liquidityChart.destroy();
                
                const otherAssets = bs.totalCurrentAssets - (bs.cashAndCashEquivalents + bs.inventory + bs.netReceivables);
                
                liquidityChart = new Chart(ctxLiquidity, {
                    type: 'doughnut',
                    data: {
                        labels: ['Cash', 'Inventory', 'Receivables', 'Other'],
                        datasets: [{
                            data: [bs.cashAndCashEquivalents, bs.inventory, bs.netReceivables, otherAssets > 0 ? otherAssets : 0],
                            backgroundColor: ['#00e676', '#d50000', '#ff9100', '#546e7a'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { boxWidth: 10, color: '#fff', font: {size: 9} } }
                        },
                        cutout: '65%'
                    }
                });

                // 5. Business Model Logic (User Provided)
                const riskTextBox = document.getElementById('risk-narrative');
                // Logic based on: cr (1.2 threshold), margin (15 threshold), conv (1.0 threshold)
                
                if (cr < 1.2 && margin > 15 && conv >= 1.0) {
                    riskTextBox.innerText = "Low current ratio, healthy margins & cash conversion: The business is profitable and brings in cash quickly, but it keeps very little cash or short-term assets on hand. This is usually manageable in stable conditions, but it can become risky if sales slow down or unexpected expenses arise.";
                } else if (cr > 1.2 && margin < 15 && conv >= 1.0) {
                    riskTextBox.innerText = "Low net margin, healthy liquidity & cash conversion: The business handles cash well and can meet short-term obligations, but it earns only a small profit on each sale. This leaves little room for error and increases risk if costs rise or competition forces lower prices.";
                } else if (cr > 1.2 && margin > 15 && conv < 1.0) {
                    riskTextBox.innerText = "Poor cash conversion, healthy margin & liquidity: The business reports good profits and appears financially stable, but much of the cash is tied up in receivables or inventory. This means profits may not turn into usable cash quickly, creating funding pressure as the business grows.";
                } else {
                    riskTextBox.innerText = "Mixed Resilience: Navigating standard trade-offs. The company displays a mixed profile that does not fit a single extreme risk category, suggesting a balance between operational efficiency and financial structuring.";
                }

                // --- END RISK DIAGNOSTICS ---

                // Chart
                const ctx = document.getElementById('priceChart').getContext('2d');
                if (priceChart) priceChart.destroy();
                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.map(d => d.date.substring(5)),
                        datasets: [{ data: history.map(d => d.price), borderColor: themeColor, tension: 0.3, fill: false }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                document.getElementById('mainUI').style.display = 'block';
                // switchTab('val'); // Commented out to stay on current tab if desired, or default to Val
                // We'll just default to val on load, but manual switches work
            } catch (e) { console.error(e); } finally { document.getElementById('loader').style.display = 'none'; }
        }
    </script>
</body>
</html>
