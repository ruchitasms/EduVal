<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Energy Valuation Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .result-card { display: none; margin-top: 20px; }
        .chart-container { height: 250px; margin-bottom: 20px; }
        .pos { color: #27ae60; font-weight: bold; }
        .neg { color: #e74c3c; font-weight: bold; }
        .glossary { background: #f4f7f9; padding: 25px; border-radius: 12px; margin-top: 30px; border-left: 6px solid #3b4d61; }
        progress { display: none; }
    </style>
</head>
<body>
    <main class="container">
        <hgroup style="margin-top:40px;">
            <h1>Energy Valuation Tracker</h1>
            <p><strong>Method:</strong> Relative Valuation (EV/EBITDA)</p>
        </hgroup>

        <article>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="ticker" placeholder="Enter Ticker (e.g. XOM)" style="margin-bottom:0;">
                <button onclick="getValuation()">Generate Report</button>
            </div>
            <progress id="loader"></progress>
        </article>

        <div id="output" class="result-card">
            <div class="grid">
                <article>
                    <header><h4 id="compName">Company</h4></header>
                    <p><strong>EV/EBITDA (TTM):</strong> <span id="multiple" style="font-size: 1.6rem; color: #3b4d61;">-</span></p>
                    <div class="chart-container">
                        <canvas id="valChart"></canvas>
                    </div>
                </article>

                <article>
                    <header><h4>Market Momentum</h4></header>
                    <div class="chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                    <table role="grid">
                        <tbody id="perfBody"></tbody>
                    </table>
                </article>
            </div>

            <section class="glossary">
                <h3>Making Sense of the Metrics</h3>
                <div class="grid">
                    <div>
                        <strong>What is Relative Valuation?</strong>
                        <p>It compares what the market pays for $1 of profit here vs. competitors. It's a "reality check" for stock prices.</p>
                    </div>
                    <div>
                        <strong>EV/EBITDA (The Enterprise Multiple)</strong>
                        <p>Calculated as $EV \div EBITDA$. It shows how many years of cash profit it takes to buy the whole business. <strong>6x to 9x</strong> is usually the "value" zone for Energy.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        let myChart = null;
        let lineChart = null;
        const API_KEY = '1YJOf8Lz9qJUlyPUhgKqc3vpzMflW1mx'; 

        async function getValuation() {
            const ticker = document.getElementById('ticker').value.toUpperCase().trim();
            if(!ticker) return;

            document.getElementById('loader').style.display = 'block';
            document.getElementById('output').style.display = 'none';

            try {
                // We use the 'stable' path you verified manually
                const urls = [
                    `https://financialmodelingprep.com/stable/profile?symbol=${ticker}&apikey=${API_KEY}`,
                    `https://financialmodelingprep.com/stable/key-metrics-ttm?symbol=${ticker}&apikey=${API_KEY}`,
                    `https://financialmodelingprep.com/stable/historical-price-eod/light?symbol=${ticker}&apikey=${API_KEY}`
                ];

                const [pRes, mRes, hRes] = await Promise.all(urls.map(url => fetch(url)));
                
                const profileData = await pRes.json();
                const metricsData = await mRes.json();
                const historyData = await hRes.json();

                if (!profileData.length) throw new Error("Ticker not found");

                const profile = profileData[0];
                const metrics = metricsData[0] || {};
                const history = historyData.historical || [];

                // Update UI
                document.getElementById('compName').innerText = profile.companyName;
                const evEbitda = metrics.evToEbitdaTTM || metrics.enterpriseValueOverEBITDATTM;
                document.getElementById('multiple').innerText = evEbitda ? `${evEbitda.toFixed(2)}x` : "N/A";

                document.getElementById('perfBody').innerHTML = `
                    <tr><td>Latest Price</td><td>$${profile.price.toFixed(2)}</td></tr>
                    <tr><td>Market Cap</td><td>$${(profile.marketCap/1e9).toFixed(2)}B</td></tr>
                    <tr><td>52W Range</td><td>${profile.range}</td></tr>
                `;

                // Charts
                renderDonut(profile.marketCap, metrics.totalDebtTTM || 0, metrics.netCashTTM || 0);
                renderLine(history.slice(0, 30).reverse());

                document.getElementById('output').style.display = 'block';
            } catch (e) {
                console.error("Critical Error:", e);
                alert("Error: Check the console (F12) for details. Usually a CORS or Ticker issue.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderDonut(mkt, debt, cash) {
            const ctx = document.getElementById('valChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Equity', 'Debt', 'Cash'],
                    datasets: [{
                        data: [mkt, debt, Math.abs(cash)],
                        backgroundColor: ['#3b4d61', '#d35400', '#27ae60']
                    }]
                }
            });
        }

        function renderLine(data) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            if(lineChart) lineChart.destroy();
            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date.split('-').slice(1).join('/')),
                    datasets: [{
                        label: 'Price',
                        data: data.map(d => d.close),
                        borderColor: '#3b4d61',
                        fill: true,
                        backgroundColor: 'rgba(59, 77, 97, 0.1)',
                        tension: 0.3
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>
