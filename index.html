<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Energy Valuation & Performance</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .result-card { display: none; margin-top: 20px; }
        .chart-container { height:250px; margin-bottom: 20px; }
        .pos { color: #27ae60; font-weight: bold; }
        .neg { color: #e74c3c; font-weight: bold; }
        progress { display: none; }
    </style>
</head>
<body>
    <main class="container">
        <hgroup style="margin-top:40px;">
            <h1>Energy Valuation Tracker</h1>
            <p>Method: Relative Valuation & Market Performance</p>
        </hgroup>

        <article>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="ticker" placeholder="XOM" style="margin-bottom:0;">
                <button onclick="getValuation()">Analyze Asset</button>
            </div>
            <progress id="loader"></progress>
        </article>

        <div id="output" class="result-card">
            <div class="grid">
                <article>
                    <header><h4 id="compName">Company</h4></header>
                    <p><strong>EV/EBITDA:</strong> <span id="multiple"></span></p>
                    <p><strong>Status:</strong> <span id="status"></span></p>
                    <div class="chart-container">
                        <canvas id="valChart"></canvas>
                    </div>
                </article>

                <article>
                    <header><h4>Market Performance</h4></header>
                    <table role="grid">
                        <thead>
                            <tr><th>Metric</th><th>Value</th></tr>
                        </thead>
                        <tbody id="perfBody"></tbody>
                    </table>
                </article>
            </div>
        </div>
    </main>

    <script>
        let myChart = null;
        // REPLACE THIS WITH YOUR KEY FROM FINANCIAL MODELING PREP
        const API_KEY = 'YOUR_API_KEY_HERE'; 

        async function getValuation() {
            const ticker = document.getElementById('ticker').value.toUpperCase();
            if(!ticker || API_KEY === '1YJOf8Lz9qJUlyPUhgKqc3vpzMflW1mx') {
                alert("Please enter a ticker and ensure your API Key is pasted in the code!");
                return;
            }

            document.getElementById('loader').style.display = 'block';
            document.getElementById('output').style.display = 'none';

            try {
                // Fetch Key Metrics & Price in parallel
                const [metricRes, quoteRes] = await Promise.all([
                    fetch(`https://financialmodelingprep.com/api/v3/key-metrics-ttm/${ticker}?apikey=${API_KEY}`),
                    fetch(`https://financialmodelingprep.com/api/v3/quote/${ticker}?apikey=${API_KEY}`)
                ]);

                const metrics = (await metricRes.json())[0];
                const quote = (await quoteRes.json())[0];

                if (!metrics || !quote) throw new Error("Ticker not found");

                // Logic: Enterprise Value Calculation
                const ev = metrics.enterpriseValueTTM;
                const multiple = metrics.evToEbitdaTTM;
                const mktCap = quote.marketCap;

                // UI Updates
                document.getElementById('compName').innerText = quote.name;
                document.getElementById('multiple').innerText = multiple ? `${multiple.toFixed(2)}x` : "N/A";
                document.getElementById('status').innerText = multiple < 8 ? "Potential Value Play" : "Growth/Premium";

                // Performance Table Logic
                const change = quote.changesPercentage;
                document.getElementById('perfBody').innerHTML = `
                    <tr><td>Price</td><td>$${quote.price.toFixed(2)}</td></tr>
                    <tr><td>% Change</td><td class="${change >= 0 ? 'pos' : 'neg'}">${change.toFixed(2)}%</td></tr>
                    <tr><td>52W Range</td><td>$${quote.yearLow} - $${quote.yearHigh}</td></tr>
                    <tr><td>Avg Volume</td><td>${(quote.avgVolume/1e6).toFixed(1)}M</td></tr>
                `;

                renderChart(mktCap, metrics.totalDebtTTM || 0, metrics.netCashTTM || 0);
                document.getElementById('output').style.display = 'block';
            } catch (e) {
                alert("Error: Data unavailable. Check your API key or ticker.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderChart(mkt, debt, cash) {
            const ctx = document.getElementById('valChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Market Cap', 'Debt', 'Cash'],
                    datasets: [{
                        data: [mkt, debt, cash],
                        backgroundColor: ['#3b4d61', '#d35400', '#27ae60']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
