<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Energy Valuation Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --pico-primary: #3b4d61; }
        .result-card { display: none; margin-top: 20px; }
        .chart-box { height: 280px; margin-bottom: 20px; background: #fff; border: 1px solid #e1e4e8; border-radius: 8px; padding: 10px; }
        .glossary { background: #f9fafb; padding: 25px; border-radius: 12px; margin-top: 30px; border-left: 6px solid #3b4d61; }
        .metric-val { font-size: 1.8rem; font-weight: 700; color: #3b4d61; }
        progress { display: none; }
    </style>
</head>
<body>
    <main class="container">
        <hgroup style="margin-top:40px;">
            <h1>Energy Valuation Tracker</h1>
            <p>Institutional-Grade Relative Analysis</p>
        </hgroup>

        <article>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="ticker" placeholder="XOM, CVX, BP..." style="margin-bottom:0;">
                <button onclick="getValuation()">Analyze Ticker</button>
            </div>
            <progress id="loader"></progress>
        </article>

        <div id="output" class="result-card">
            <div class="grid">
                <article>
                    <header><h4 id="displayTicker">---</h4></header>
                    <p>EV/EBITDA (TTM)</p>
                    <div class="metric-val" id="multiple">-</div>
                    <div class="chart-box">
                        <canvas id="valChart"></canvas>
                    </div>
                </article>

                <article>
                    <header><h4>7-Day Price Trend</h4></header>
                    <p>Recent Momentum</p>
                    <div class="metric-val" id="lastPrice">-</div>
                    <div class="chart-box">
                        <canvas id="historyChart"></canvas>
                    </div>
                </article>
            </div>

            <section class="glossary">
                <h3>Metric Insights</h3>
                <div class="grid">
                    <div>
                        <strong>Relative Valuation</strong>
                        <p>Instead of guessing a stock's "true" value, we compare it to peers. If XOM has an EV/EBITDA of 8x while the sector average is 10x, it is "relatively" cheap.</p>
                    </div>
                    <div>
                        <strong>EV/EBITDA (The Cash Multiple)</strong>
                        <p>Calculated as $EV \div EBITDA$. It tells you how much you're paying for every dollar of operational cash flow. In energy, lower is generally better value.</p>
                    </div>
                </div>
                <hr>
                <p>ðŸ’¡ <strong>Strategic Note:</strong> A rising 7-day trend paired with a low EV/EBITDA indicates a company gaining market composure while remaining fundamentally affordable.</p>
            </section>
        </div>
    </main>

    <script>
        let donut = null, line = null;
        const KEY = '1YJOf8Lz9qJUlyPUhgKqc3vpzMflW1mx'; 

        async function getValuation() {
            const sym = document.getElementById('ticker').value.toUpperCase().trim();
            if(!sym) return;

            document.getElementById('loader').style.display = 'block';
            document.getElementById('output').style.display = 'none';

            try {
                const [pRes, mRes, hRes] = await Promise.all([
                    fetch(`https://financialmodelingprep.com/stable/profile?symbol=${sym}&apikey=${KEY}`),
                    fetch(`https://financialmodelingprep.com/stable/key-metrics-ttm?symbol=${sym}&apikey=${KEY}`),
                    fetch(`https://financialmodelingprep.com/stable/historical-price-eod/light?symbol=${sym}&apikey=${KEY}`)
                ]);

                const p = (await pRes.json())[0];
                const m = (await mRes.json())[0];
                const h = await hRes.json();

                if (!p) throw new Error("Ticker not found");

                // 1. Text Data
                document.getElementById('displayTicker').innerText = p.companyName;
                document.getElementById('lastPrice').innerText = `$${p.price.toFixed(2)}`;
                
                // Using the specific TTM field for EV/EBITDA
                const evEbitda = m.evToEbitdaTTM || m.enterpriseValueOverEBITDATTM;
                document.getElementById('multiple').innerText = evEbitda ? `${evEbitda.toFixed(2)}x` : "Data N/A";

                // 2. Capital Structure Donut (Equity vs Debt in Dollars)
                const ctxD = document.getElementById('valChart').getContext('2d');
                if(donut) donut.destroy();
                donut = new Chart(ctxD, {
                    type: 'doughnut',
                    data: {
                        labels: ['Equity (Mkt Cap)', 'Total Debt'],
                        datasets: [{
                            data: [p.marketCap, m.totalDebtTTM || 0],
                            backgroundColor: ['#3b4d61', '#d35400']
                        }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });

                // 3. 7-Day History Line Chart
                const ctxL = document.getElementById('historyChart').getContext('2d');
                if(line) line.destroy();
                
                // Get exactly 7 days and reverse to chronological order
                const history = h.historical ? h.historical.slice(0, 7).reverse() : [];
                
                line = new Chart(ctxL, {
                    type: 'line',
                    data: {
                        // Formatting date as MM/DD
                        labels: history.map(d => d.date.substring(5).replace('-', '/')), 
                        datasets: [{
                            data: history.map(d => d.close),
                            borderColor: '#3b4d61',
                            fill: true,
                            backgroundColor: 'rgba(59, 77, 97, 0.1)',
                            tension: 0.3,
                            pointRadius: 4
                        }]
                    },
                    options: { 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { 
                            x: { grid: { display: false } },
                            y: { ticks: { callback: value => '$' + value } }
                        }
                    }
                });

                document.getElementById('output').style.display = 'block';
            } catch (err) {
                alert("Could not load ticker. Please check your spelling or API limit.");
                console.error(err);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }
    </script>
</body>
</html>
