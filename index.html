<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Energy Valuation Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .result-card { display: none; margin-top: 20px; }
        .chart-container { height:280px; margin-bottom: 20px; }
        .pos { color: #27ae60; font-weight: bold; }
        .neg { color: #e74c3c; font-weight: bold; }
        progress { display: none; }
    </style>
</head>
<body>
    <main class="container">
        <hgroup style="margin-top:40px;">
            <h1>Energy Valuation Tracker</h1>
            <p><strong>Method:</strong> Relative Valuation (EV/EBITDA) & Performance</p>
        </hgroup>

        <article>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="ticker" placeholder="XOM" style="margin-bottom:0;">
                <button onclick="getValuation()">Analyze Asset</button>
            </div>
            <progress id="loader"></progress>
        </article>

        <div id="output" class="result-card">
            <div class="grid">
                <article>
                    <header><h4 id="compName">Company</h4></header>
                    <p><strong>EV/EBITDA:</strong> <span id="multiple">Calculating...</span></p>
                    <p><strong>Status:</strong> <span id="status">...</span></p>
                    <div class="chart-container">
                        <canvas id="valChart"></canvas>
                    </div>
                </article>

                <article>
                    <header><h4>Performance Metrics</h4></header>
                    <table role="grid">
                        <thead>
                            <tr><th>Metric</th><th>Value</th></tr>
                        </thead>
                        <tbody id="perfBody"></tbody>
                    </table>
                    <footer>
                        <small>Data Source: FMP Stable API</small>
                    </footer>
                </article>
            </div>
        </div>
    </main>

    <script>
        let myChart = null;
        // Using the key you found
        const API_KEY = '1YJOf8Lz9qJUlyPUhgKqc3vpzMflW1mx'; 

        async function getValuation() {
            const ticker = document.getElementById('ticker').value.toUpperCase();
            if(!ticker) return;

            document.getElementById('loader').style.display = 'block';
            document.getElementById('output').style.display = 'none';

            try {
                // Using the 'stable' profile endpoint and the 'key-metrics' endpoint
                const [profileRes, metricsRes] = await Promise.all([
                    fetch(`https://financialmodelingprep.com/stable/profile?symbol=${ticker}&apikey=${API_KEY}`),
                    fetch(`https://financialmodelingprep.com/api/v3/key-metrics-ttm/${ticker}?apikey=${API_KEY}`)
                ]);

                const profileData = await profileRes.json();
                const metricsData = await metricsRes.json();

                if (!profileData.length) throw new Error("Ticker not found");

                const profile = profileData[0];
                const metrics = metricsData[0] || {};

                // 1. Valuation Logic
                const mktCap = profile.marketCap || 0;
                // Enterprise Value = Market Cap + Debt - Cash
                // We'll use the pre-calculated EV from metrics if available
                const ev = metrics.enterpriseValueTTM || mktCap; 
                const multiple = metrics.evToEbitdaTTM || 0;

                document.getElementById('compName').innerText = profile.companyName;
                document.getElementById('multiple').innerText = multiple ? `${multiple.toFixed(2)}x` : "N/A";
                
                // Relative valuation logic: Energy sector average is usually 6x-10x
                let status = "Fair Value";
                if(multiple > 0 && multiple < 7) status = "Potential Value Play (Undervalued)";
                else if(multiple >= 12) status = "Growth/Premium (Mythic Potential)";
                document.getElementById('status').innerText = status;

                // 2. Performance Table
                const change = profile.changePercentage || 0;
                document.getElementById('perfBody').innerHTML = `
                    <tr><td>Current Price</td><td>$${profile.price}</td></tr>
                    <tr><td>Daily Change</td><td class="${change >= 0 ? 'pos' : 'neg'}">${change.toFixed(2)}%</td></tr>
                    <tr><td>52W Range</td><td>${profile.range}</td></tr>
                    <tr><td>Market Cap</td><td>$${(mktCap/1e9).toFixed(2)}B</td></tr>
                `;

                // 3. Chart Logic
                renderChart(mktCap, metrics.totalDebtTTM || 0, metrics.netCashTTM || 0);
                document.getElementById('output').style.display = 'block';

            } catch (e) {
                console.error(e);
                alert("Error fetching data. Ensure the ticker is correct.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderChart(mkt, debt, cash) {
            const ctx = document.getElementById('valChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Equity (Mkt Cap)', 'Debt', 'Cash'],
                    datasets: [{
                        data: [mkt, debt, Math.abs(cash)],
                        backgroundColor: ['#3b4d61', '#d35400', '#27ae60']
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
    </script>
</body>
</html>
