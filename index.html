<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Valuation Pro Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .result-card { display: none; margin-top: 20px; }
        .chart-container { height: 250px; margin-bottom: 20px; }
        .pos { color: #27ae60; font-weight: bold; }
        .neg { color: #e74c3c; font-weight: bold; }
        .glossary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px; border-left: 5px solid #3b4d61; }
        progress { display: none; }
    </style>
</head>
<body>
    <main class="container">
        <hgroup style="margin-top:40px;">
            <h1>Energy Valuation Tracker</h1>
            <p><strong>Method:</strong> Relative Valuation Dashboard</p>
        </hgroup>

        <article>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="ticker" placeholder="XOM" style="margin-bottom:0;">
                <button onclick="getValuation()">Deep Analyze</button>
            </div>
            <progress id="loader"></progress>
        </article>

        <div id="output" class="result-card">
            <div class="grid">
                <article>
                    <header><h4 id="compName">Company</h4></header>
                    <p><strong>EV/EBITDA (TTM):</strong> <span id="multiple" style="font-size: 1.5rem; color: #3b4d61;">-</span></p>
                    <div class="chart-container">
                        <canvas id="valChart"></canvas>
                    </div>
                </article>

                <article>
                    <header><h4>Market Context</h4></header>
                    <div class="chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                    <table role="grid">
                        <tbody id="perfBody"></tbody>
                    </table>
                </article>
            </div>

            <section class="glossary">
                <h3>Insights & Definitions</h3>
                <div class="grid">
                    <div>
                        <strong>Relative Valuation</strong>
                        <p>Unlike a DCF (which guesses future cash), this method compares a company to its peers. It asks: "Is this stock cheaper or more expensive than the average Energy company right now?"</p>
                    </div>
                    <div>
                        <strong>EV/EBITDA (The Enterprise Multiple)</strong>
                        <p>It shows how many years of "core cash profit" it would take to pay back the cost of buying the entire business (Price + Debt). <strong>Under 8x</strong> is often considered a "Value" entry for Energy.</p>
                    </div>
                </div>
                <hr>
                <p><em><strong>Logical Conclusion:</strong> If the line graph is trending up while the EV/EBITDA stays low, you've found a company growing efficiently without becoming "overpriced."</em></p>
            </section>
        </div>
    </main>

    <script>
        let myChart = null;
        let historyChart = null;
        const API_KEY = '1YJOf8Lz9qJUlyPUhgKqc3vpzMflW1mx'; 

        async function getValuation() {
            const ticker = document.getElementById('ticker').value.toUpperCase();
            if(!ticker) return;

            document.getElementById('loader').style.display = 'block';
            document.getElementById('output').style.display = 'none';

            try {
                // Fetch Profile, Metrics (for EV/EBITDA), and Historical Price
                const [profileRes, metricsRes, historyRes] = await Promise.all([
                    fetch(`https://financialmodelingprep.com/stable/profile?symbol=${ticker}&apikey=${API_KEY}`),
                    fetch(`https://financialmodelingprep.com/api/v3/key-metrics-ttm/${ticker}?apikey=${API_KEY}`),
                    fetch(`https://financialmodelingprep.com/api/v3/historical-price-full/${ticker}?timeseries=30&apikey=${API_KEY}`)
                ]);

                const profile = (await profileRes.json())[0];
                const metrics = (await metricsRes.json())[0];
                const history = await historyRes.json();

                if (!profile) throw new Error("Not Found");

                // Update Valuation
                const evEbitda = metrics.evToEbitdaTTM;
                document.getElementById('compName').innerText = profile.companyName;
                document.getElementById('multiple').innerText = evEbitda ? `${evEbitda.toFixed(2)}x` : "N/A";

                // Update Performance Table
                document.getElementById('perfBody').innerHTML = `
                    <tr><td>Price</td><td>$${profile.price.toFixed(2)}</td></tr>
                    <tr><td>Market Cap</td><td>$${(profile.marketCap/1e9).toFixed(2)}B</td></tr>
                    <tr><td>EV</td><td>$${(metrics.enterpriseValueTTM/1e9).toFixed(2)}B</td></tr>
                `;

                // Render Charts
                renderDonut(profile.marketCap, metrics.totalDebtTTM || 0, metrics.netCashTTM || 0);
                renderLine(history.historical.reverse());

                document.getElementById('output').style.display = 'block';
            } catch (e) {
                alert("Data Error. Check if ticker is valid.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderDonut(mkt, debt, cash) {
            const ctx = document.getElementById('valChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Equity', 'Debt', 'Cash'],
                    datasets: [{
                        data: [mkt, debt, Math.abs(cash)],
                        backgroundColor: ['#3b4d61', '#d35400', '#27ae60']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderLine(data) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            if(historyChart) historyChart.destroy();
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date.split('-').slice(1).join('/')),
                    datasets: [{
                        label: '30D Price Trend',
                        data: data.map(d => d.close),
                        borderColor: '#3b4d61',
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(59, 77, 97, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
    </script>
</body>
</html>
